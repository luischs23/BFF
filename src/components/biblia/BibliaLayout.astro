---
import Layout from "../../layouts/Layout.astro";
import MobileHeader from "./MobileHeader.astro";
import Sidebar from "./Sidebar.astro";
import ChapterNavPanel from "./ChapterNavPanel.astro";
import LoadingState from "./LoadingState.astro";
import BibleContent from "./BibleContent.astro";
import CommentDialog from "./CommentDialog.astro";
import ParallelsDialog from "./ParallelsDialog.astro";
import type { EstructuraBiblia } from "../../lib/biblia/types";

interface Props {
	title: string;
	slug: string;
	estructura: EstructuraBiblia;
}

const { title, slug, estructura } = Astro.props;
---

<Layout title={`${title} - Sagrada Biblia`}>
	<div id="bibliaContainer" class="flex h-screen relative bg-amber-50/70 dark:bg-gray-900 transition-colors duration-300">
		<!-- Overlay para móvil -->
		<div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

		<!-- Header móvil con auto-hide -->
		<MobileHeader title={title} />

		<!-- Panel de navegación de capítulos -->
		<ChapterNavPanel />

		<!-- Sidebar -->
		<Sidebar estructura={estructura} currentSlug={slug} />

		<!-- Contenido principal -->
		<main
			class="flex-1 overflow-y-auto
					bg-amber-50 dark:bg-gray-950
					md:bg-stone-300 md:dark:bg-gray-950
					transition-colors duration-300">
			<div class="p-0 md:p-8">
				<!-- Estado de carga -->
				<LoadingState />

				<!-- Contenedor del libro -->
				<BibleContent>
					<slot />
				</BibleContent>
			</div>
		</main>

		<!-- Dialogs -->
		<CommentDialog />
		<ParallelsDialog />
	</div>
</Layout>

<style is:global>
	/* ========================================
	   SCROLLBAR ESTILOS
	   ======================================== */
	aside::-webkit-scrollbar,
	main::-webkit-scrollbar {
		width: 6px;
	}
	aside::-webkit-scrollbar-track,
	main::-webkit-scrollbar-track {
		background: #f5f5f4;
	}
	aside::-webkit-scrollbar-thumb,
	main::-webkit-scrollbar-thumb {
		background: #d6d3d1;
		border-radius: 3px;
	}
	aside::-webkit-scrollbar-thumb:hover,
	main::-webkit-scrollbar-thumb:hover {
		background: #a8a29e;
	}

	/* Dark mode scrollbar */
	.dark aside::-webkit-scrollbar-track,
	.dark main::-webkit-scrollbar-track {
		background: #1f2937;
	}
	.dark aside::-webkit-scrollbar-thumb,
	.dark main::-webkit-scrollbar-thumb {
		background: #4b5563;
	}
	.dark aside::-webkit-scrollbar-thumb:hover,
	.dark main::-webkit-scrollbar-thumb:hover {
		background: #6b7280;
	}

	/* ========================================
	   SIDEBAR ESTILOS
	   ======================================== */
	/* Estilos para secciones contraíbles del sidebar */
	.section-content {
		overflow: hidden;
		transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
		max-height: 1000px;
		opacity: 1;
	}

	.section-content.collapsed {
		max-height: 0;
		opacity: 0;
	}

	.toggle-icon {
		transition: transform 0.3s ease;
	}

	.toggle-icon.rotated {
		transform: rotate(-90deg);
	}

	/* Header auto-hide - mejorado */
	#mobileHeader {
		transform: translateY(0);
		transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	}

	#mobileHeader.header-hidden {
		transform: translateY(-100%);
	}

	/* Ajustar padding del contenido principal para el header fijo */
	#bibliaContainer > main {
		padding-top: 4rem !important;
	}

	#bibliaContainer > main > div:first-child {
		padding-top: 0.5rem;
	}

	/* Asegurar que el header esté por encima de todo */
	#mobileHeader {
		z-index: 60 !important;
	}

	/* Padding para compensar la barra de progreso en móvil */
	@media (max-width: 767px) {
		#bibliaContainer > main {
			padding-left: 0.5rem;
		}
	}

	/* Panel de navegación de capítulos */
	#chapterNavPanel {
		animation: slideIn 0.2s ease-out;
	}

	@keyframes slideIn {
		from {
			opacity: 0;
			transform: translateX(10px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	#chapterGrid button {
		width: 36px;
		height: 36px;
		font-size: 0.85rem;
		font-weight: 500;
		border-radius: 6px;
		transition: all 0.15s ease;
	}

	#chapterGrid button:hover {
		transform: scale(1.1);
	}

	#chapterGrid button.current-chapter {
		background-color: #b45309;
		color: white;
		font-weight: 700;
	}

	.dark #chapterGrid button.current-chapter {
		background-color: #f59e0b;
		color: #1f2937;
	}

	/* Mostrar capítulo actual en el panel */
	.chapter-indicator {
		position: fixed;
		right: 3.5rem;
		bottom: 1rem;
		background: rgba(180, 83, 9, 0.9);
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 9999px;
		font-weight: 600;
		font-size: 0.875rem;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		z-index: 40;
		opacity: 0;
		transition: opacity 0.3s ease;
		pointer-events: none;
	}

	.chapter-indicator.visible {
		opacity: 1;
	}

	.dark .chapter-indicator {
		background: rgba(245, 158, 11, 0.9);
		color: #1f2937;
	}

	/* Scroll suave para los botones */
	#scrollTopBtn,
	#scrollBottomBtn {
		transition: opacity 0.3s ease, transform 0.15s ease;
	}

	#scrollTopBtn:hover,
	#scrollBottomBtn:hover {
		transform: scale(1.1);
	}

	#scrollTopBtn.visible {
		opacity: 1;
		pointer-events: auto;
	}

	/* Estilos para la barra de progreso */
	#readingProgressBar {
		transition: opacity 0.3s ease;
	}

	#progressHandle {
		transform: translateY(-50%);
	}

	#progressHandle:active {
		cursor: grabbing;
	}

	/* ========================================
	   DIALOGS ESTILOS
	   ======================================== */
	/* Dialog de comentarios y paralelos - centrado */
	#commentDialog,
	#parallelsDialog {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		margin: 0;
	}

	#commentDialog::backdrop,
	#parallelsDialog::backdrop {
		background: rgba(0, 0, 0, 0.6);
	}

	#commentDialog[open],
	#parallelsDialog[open] {
		animation: dialogFadeIn 0.2s ease-out;
	}

	@keyframes dialogFadeIn {
		from {
			opacity: 0;
			transform: translate(-50%, -50%) scale(0.95);
		}
		to {
			opacity: 1;
			transform: translate(-50%, -50%) scale(1);
		}
	}

	/* Lista de paralelos en el dialog */
	.parallels-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.parallels-list li {
		padding: 0.75rem 1rem;
		border-bottom: 1px solid #e5e7eb;
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.dark .parallels-list li {
		border-bottom-color: #374151;
	}

	.parallels-list li:last-child {
		border-bottom: none;
	}

	.parallels-list a {
		color: #2563eb;
		text-decoration: none;
		font-weight: 500;
	}

	.parallels-list a:hover {
		text-decoration: underline;
	}

	.dark .parallels-list a {
		color: #60a5fa;
	}

	.parallel-badge {
		font-size: 0.65rem;
		padding: 0.15rem 0.4rem;
		border-radius: 0.25rem;
		font-weight: 600;
		text-transform: uppercase;
	}

	.parallel-badge.nt {
		background-color: #dbeafe;
		color: #1e40af;
	}

	.dark .parallel-badge.nt {
		background-color: #1e3a5f;
		color: #93c5fd;
	}

	.parallel-badge.at {
		background-color: #fef3c7;
		color: #92400e;
	}

	.dark .parallel-badge.at {
		background-color: #451a03;
		color: #fcd34d;
	}

	/* ========================================
	   BIBLE CONTENT ESTILOS
	   ======================================== */
	/* Contenido de la biblia */
	.bible-content {
		font-family: "Times New Roman", Times, serif;
	}

	/* Cada página es un contenedor */
	.bible-content .bible-page-content {
		padding: 2rem 2.5rem;
		position: relative;
	}

	@media (min-width: 768px) {
		.bible-content .bible-page-content {
			padding: 2.5rem 3rem;
		}
	}

	/* Contenedor de columnas CSS - permite que el texto fluya naturalmente */
	.bible-content .bible-columns-wrapper {
		columns: 1;
		column-gap: 3rem;
		column-rule: 1px solid #d6d3d1;
		min-height: 700px;
		text-align: justify;
	}

	.dark .bible-content .bible-columns-wrapper {
		column-rule-color: #374151;
	}

	/* Evitar que los encabezados se queden solos al final de una columna */
	.bible-content .bible-columns-wrapper h2,
	.bible-content .bible-columns-wrapper h3 {
		break-after: avoid;
	}

	/* Responsive: una columna en móvil */
	@media (max-width: 768px) {
		.bible-content .bible-columns-wrapper {
			columns: 1;
			column-rule: none;
			min-height: auto;
		}
	}

	/* Estilos para marcadores de capítulo */
	.bible-content .chapter-marker {
		font-size: 2rem;
		font-weight: 700;
		color: #374151;
		float: left;
		line-height: 1;
		margin-right: 0.25rem;
		margin-top: 0.1rem;
		padding-right: 0.15rem;
		font-family: "Times New Roman", Times, serif;
	}

	.dark .bible-content .chapter-marker {
		color: #e5e7eb;
	}

	/* Estilos para versículos en superíndice */
	.bible-content sup {
		font-size: 0.6em;
		vertical-align: super;
		line-height: 0;
		color: #4b5563;
		font-weight: 600;
		margin-right: 1px;
	}

	.dark .bible-content sup {
		color: #9ca3af;
	}

	/* Párrafos */
	.bible-content p {
		text-align: justify;
		line-height: 1.7;
		font-size: 0.9rem;
		margin-bottom: 0.75rem;
		font-family: "Times New Roman", Times, serif;
	}

	/* Divisor de página */
	.bible-content .page-divider {
		grid-column: 1 / -1;
		width: 100%;
		height: 30px;
		margin: 1rem 0;
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		background: linear-gradient(to bottom,
			#fffbeb,
			#f5f0e1 45%,
			#d6d3d1 50%,
			#f5f0e1 55%,
			#fffbeb
		);
	}

	.dark .bible-content .page-divider {
		background: linear-gradient(to bottom,
			#1f2937,
			#263243 45%,
			#374151 50%,
			#263243 55%,
			#1f2937
		);
	}

	.bible-content .page-divider::before {
		content: '';
		position: absolute;
		left: 10%;
		right: 10%;
		top: 50%;
		height: 1px;
		background: #a8a29e;
		transform: translateY(-50%);
	}

	.dark .bible-content .page-divider::before {
		background: #4b5563;
	}

	.bible-content .page-divider span {
		position: relative;
		z-index: 1;
		background: #fffbeb;
		padding: 0 1rem;
		color: #78716c;
		font-size: 0.7rem;
		font-family: "Times New Roman", Times, serif;
	}

	.dark .bible-content .page-divider span {
		background: #1f2937;
		color: #6b7280;
	}

	/* Sombras laterales del libro */
	.bible-book {
		position: relative;
	}

	.bible-content::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 20px;
		background: linear-gradient(to right, rgba(0,0,0,0.05), transparent);
		pointer-events: none;
	}

	.bible-content::after {
		content: '';
		position: absolute;
		right: 0;
		top: 0;
		bottom: 0;
		width: 20px;
		background: linear-gradient(to left, rgba(0,0,0,0.05), transparent);
		pointer-events: none;
	}

	/* Estilos para secciones introductorias */
	.bible-content .section-intro {
		display: block;
		font-style: italic;
		text-align: center;
		font-size: 1.1rem;
		color: #3f444d;
		margin: 0.75rem 0 0.5rem 0;
		font-weight: 500;
		letter-spacing: 0.025em;
		line-height: 1.3;
	}

	.dark .bible-content .section-intro {
		color: #9ca3af;
	}

	/* Subtítulos de subsección centrados */
	.bible-content h2 .subsection-title {
		display: block;
		text-align: center;
		font-weight: 600;
		color: #374151;
		letter-spacing: 0.05em;
		margin: 0.25rem 0;
		line-height: 1.2;
	}

	.dark .bible-content h2 .subsection-title {
		color: #e5e7eb;
	}

	/* Referencias paralelas - con indentación y números de capítulo en negrita */
	.bible-content .parallel-ref {
		display: block;
		font-family: "Times New Roman", Times, serif;
		font-size: 0.85rem;
		color: #4b5563;
		margin: 0.1rem 0 0.1rem 1.5rem;
		padding-left: 0.5rem;
		line-height: 1.3;
		font-weight: 400;
		break-inside: avoid;
	}

	.dark .bible-content .parallel-ref {
		color: #9ca3af;
	}

	/* Números de capítulo en negrita dentro de paralelos */
	.bible-content .parallel-ref strong {
		font-weight: 700;
		color: #374151;
	}

	.dark .bible-content .parallel-ref strong {
		color: #e5e7eb;
	}

	/* Título principal del libro (h1) - más pequeño y centrado */
	.bible-content h1 {
		text-align: center;
		font-size: 1.5rem;
		font-weight: 700;
		color: #1f2937;
		margin: 0.5rem 0 0.25rem 0;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		line-height: 1.2;
	}

	.dark .bible-content h1 {
		color: #f3f4f6;
	}

	@media (min-width: 768px) {
		.bible-content h1 {
			font-size: 1.75rem;
		}
	}

	/* Reducir margen de TODOS los h2 */
	.bible-content h2 {
		margin-top: 0.5rem !important;
		margin-bottom: 0.25rem !important;
		line-height: 1.3;
	}

	/* Estilos para notas al pie (asteriscos clicables) */
	.bible-content .note-ref {
		color: #b45309;
		cursor: pointer;
		font-weight: 700;
		font-size: 1em;
		transition: color 0.2s;
		display: inline;
		user-select: none;
		padding: 0 1px;
		position: relative;
	}

	.bible-content .note-ref:hover {
		color: #92400e;
		text-decoration: underline;
	}

	.dark .bible-content .note-ref {
		color: #fbbf24;
	}

	.dark .bible-content .note-ref:hover {
		color: #fcd34d;
		text-decoration: underline;
	}

	/* Estilos para versículos clicables */
	.bible-content sup.verse-clickable {
		cursor: pointer;
		transition: all 0.2s ease;
		padding: 0 2px;
		border-radius: 2px;
	}

	.bible-content sup.verse-clickable:hover {
		background-color: rgba(59, 130, 246, 0.2);
		color: #2563eb;
	}

	.dark .bible-content sup.verse-clickable:hover {
		background-color: rgba(96, 165, 250, 0.2);
		color: #60a5fa;
	}

	/* Indicador de que el versículo tiene paralelos - color ámbar */
	.bible-content sup.verse-clickable.has-parallels {
		color: #b45309;
		font-weight: 700;
	}

	.dark .bible-content sup.verse-clickable.has-parallels {
		color: #fbbf24;
	}

	.bible-content sup.verse-clickable.has-parallels:hover {
		background-color: rgba(180, 83, 9, 0.15);
		color: #92400e;
	}

	.dark .bible-content sup.verse-clickable.has-parallels:hover {
		background-color: rgba(251, 191, 36, 0.2);
		color: #fcd34d;
	}

	/* Highlight temporal para versículo navegado */
	.verse-highlight {
		background-color: #fef08a !important;
		padding: 2px 6px;
		border-radius: 4px;
		animation: verseHighlightFade 2s ease-out forwards;
	}

	.dark .verse-highlight {
		background-color: #854d0e !important;
		animation: verseHighlightFadeDark 2s ease-out forwards;
	}

	@keyframes verseHighlightFade {
		0% { background-color: #fef08a; }
		70% { background-color: #fef08a; }
		100% { background-color: transparent; }
	}

	@keyframes verseHighlightFadeDark {
		0% { background-color: #854d0e; }
		70% { background-color: #854d0e; }
		100% { background-color: transparent; }
	}
</style>

<script define:vars={{ slug }}>
	// Variable global para el slug actual
	window.currentBibliaSlug = slug;
</script>

<script>
	import { initSectionToggles, scrollToActiveBook } from "../../scripts/biblia/sectionToggles";
	import { initMobileMenu } from "../../scripts/biblia/mobileMenu";
	import { initDarkMode } from "../../scripts/biblia/darkMode";
	import { organizeBiblePages } from "../../scripts/biblia/biblePages";
	import { initCommentSystem } from "../../scripts/biblia/comments";
	import { initParallelsSystem } from "../../scripts/biblia/parallels";
	import { initChapterNavigation } from "../../scripts/biblia/chapterNavigation";
	import { initHeaderAutoHide } from "../../scripts/biblia/headerAutoHide";
	import { initVerseNavigation } from "../../scripts/biblia/verseNavigation";

	// Función para inicializar todos los sistemas
	function initializeAll() {
		const currentSlug = (window as any).currentBibliaSlug;

		// Sistemas básicos
		initSectionToggles(currentSlug);
		scrollToActiveBook();
		initMobileMenu();
		initDarkMode();

		// Organizar páginas y mostrar contenido inmediatamente
		requestAnimationFrame(() => {
			organizeBiblePages();

			// Inicializar sistemas después de que el contenido esté visible
			initCommentSystem(currentSlug);
			initParallelsSystem(currentSlug);
			initVerseNavigation();
		});

		// Navegación
		initChapterNavigation();
		initHeaderAutoHide();
	}

	// Inicializar en la primera carga
	document.addEventListener('DOMContentLoaded', initializeAll);

	// Re-inicializar cuando Astro hace una navegación SPA (ClientRouter)
	document.addEventListener('astro:page-load', initializeAll);

	// También ejecutar navegación si el hash cambia
	window.addEventListener('hashchange', () => {
		initVerseNavigation();
	});
</script>
