---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

export async function getStaticPaths() {
    const libros = await getCollection("sagrada-biblia");

    return libros.map((book) => ({
        params: { id: book.slug },
        props: { book }
    }));
}

const { id } = Astro.params;
const { book } = Astro.props;

if (!book) {
    return Astro.redirect('/404');
}

const { data, slug, render } = book;
const { title } = data;
const { Content } = await render();

// Obtener todos los libros para el sidebar
const libros = await getCollection('sagrada-biblia');

// Organizar libros por sección
const estructura = {
	'antiguo-testamento': {
		titulo: 'Antiguo Testamento',
		secciones: {
			'01-pentateuco': { titulo: 'El Pentateuco', libros: [] as any[] },
			'02-libros-historicos': { titulo: 'Libros Históricos', libros: [] as any[] },
			'03-lirica': { titulo: 'Lírica', libros: [] as any[] },
			'04-libros-sapienciales': { titulo: 'Libros Sapienciales', libros: [] as any[] },
			'05-libros-profeticos': { titulo: 'Libros Proféticos', libros: [] as any[] },
		}
	},
	'nuevo-testamento': {
		titulo: 'Nuevo Testamento',
		secciones: {
			'01-evangelios': { titulo: 'Evangelios', libros: [] as any[] },
			'02-hechos': { titulo: 'Hechos', libros: [] as any[] },
			'03-epistolas-pablo': { titulo: 'Epístolas de Pablo', libros: [] as any[] },
			'04-hebreos': { titulo: 'Hebreos', libros: [] as any[] },
			'05-epistolas-catolicas': { titulo: 'Epístolas Católicas', libros: [] as any[] },
			'06-apocalipsis': { titulo: 'Apocalipsis', libros: [] as any[] },
		}
	}
};

libros.forEach(libro => {
	const slugParts = libro.slug.split('/');
	if (slugParts.length >= 2) {
		const testamento = slugParts[0] as keyof typeof estructura;
		const seccion = slugParts[1] as keyof typeof estructura[typeof testamento]['secciones'];
		if (estructura[testamento]?.secciones?.[seccion]) {
			(estructura[testamento].secciones as any)[seccion].libros.push(libro);
		}
	}
});

Object.values(estructura).forEach(testamento => {
	Object.values(testamento.secciones).forEach(seccion => {
		seccion.libros.sort((a, b) => a.slug.localeCompare(b.slug));
	});
});
---

<Layout title={`${title} - Sagrada Biblia`}>
	<div id="bibliaContainer" class="flex h-screen relative bg-amber-50/70 dark:bg-gray-900 transition-colors duration-300">
		<!-- Overlay para móvil -->
		<div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

		<!-- Botón menú móvil -->
		<button
			id="menuToggle"
			class="md:hidden fixed top-20 left-4 z-50 bg-amber-700 text-white p-3 rounded-lg shadow-lg hover:bg-amber-800 transition"
			aria-label="Abrir menú"
		>
			<svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
			<svg id="closeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
			</svg>
		</button>

		<!-- Sidebar -->
		<aside
			id="sidebar"
			class="fixed md:relative w-72 h-full bg-stone-100 dark:bg-gray-800 border-r border-stone-200 dark:border-gray-700 overflow-y-auto flex-shrink-0 z-50 transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out"
		>
			<div class="p-4">
				<div class="flex items-center justify-between mb-4">
					<a href="/" class="text-amber-700 dark:text-amber-400 hover:underline text-sm">&larr; Inicio</a>
					<button
						id="darkModeToggle"
						class="p-2 rounded-lg bg-stone-200 dark:bg-gray-700 hover:bg-stone-300 dark:hover:bg-gray-600 transition-colors"
						aria-label="Cambiar tema"
					>
						<!-- Sol (modo claro) -->
						<svg id="sunIcon" class="w-5 h-5 text-amber-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
						</svg>
						<!-- Luna (modo oscuro) -->
						<svg id="moonIcon" class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
						</svg>
					</button>
				</div>
				<h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Sagrada Biblia</h2>

				{Object.entries(estructura).map(([testamentoKey, testamento]) => (
					<div class="mb-6">
						<h3 class="font-bold text-gray-800 dark:text-gray-200 mb-2 text-sm uppercase tracking-wide">
							{testamento.titulo}
						</h3>

						{Object.entries(testamento.secciones).map(([seccionKey, seccion]) => (
							seccion.libros.length > 0 && (
								<div class="mb-3">
									<button
										class="section-toggle w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 pl-2 pr-2 py-1 hover:bg-stone-200 dark:hover:bg-gray-700 rounded transition"
										data-section={`${testamentoKey}-${seccionKey}`}
									>
										<span>{seccion.titulo}</span>
										<svg class="toggle-icon w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
										</svg>
									</button>
									<ul class="section-content space-y-1" data-section={`${testamentoKey}-${seccionKey}`}>
										{seccion.libros.filter(libro => !libro.data.isIntro).map(libro => (
											<li>
												<a
													href={`/biblia/${libro.slug}`}
													class:list={[
														"block px-3 py-1.5 text-sm rounded transition",
														libro.slug === slug
															? "bg-amber-200 dark:bg-amber-700 text-amber-900 dark:text-amber-100 font-semibold"
															: "text-gray-600 dark:text-gray-300 hover:bg-amber-100 dark:hover:bg-gray-700 hover:text-amber-800 dark:hover:text-amber-300"
													]}
												>
													{libro.data.title}
												</a>
											</li>
										))}
									</ul>
								</div>
							)
						))}
					</div>
				))}
			</div>
		</aside>

		<!-- Contenido principal -->
		<main class="flex-1 overflow-y-auto bg-stone-300 dark:bg-gray-950 transition-colors duration-300">
			<div class="p-4 md:p-8 pt-16 md:pt-4">
				<!-- Contenedor del libro -->
				<div class="bible-book max-w-5xl mx-auto">
					<!-- Encabezado del libro -->
					<div class="bible-page-header bg-amber-50 dark:bg-gray-800 border border-stone-300 dark:border-gray-700 border-b-0 rounded-t-sm shadow-lg px-8 py-4">
						<h1 class="text-center text-xl md:text-2xl font-serif font-bold text-gray-800 dark:text-gray-100">{title}</h1>
					</div>

					<!-- Contenido en dos columnas con divisores de página -->
					<article class="bible-content prose prose-sm max-w-none
						prose-headings:text-gray-800 dark:prose-headings:text-gray-100
						prose-h2:text-sm md:prose-h2:text-base prose-h2:font-semibold prose-h2:mt-4 prose-h2:mb-2
						prose-p:text-gray-700 dark:prose-p:text-gray-300
						dark:prose-invert
						bg-amber-50 dark:bg-gray-800
						border-x border-stone-300 dark:border-gray-700
						shadow-lg">
						<Content />
					</article>

					<!-- Pie del libro -->
					<div class="bible-page-footer bg-amber-50 dark:bg-gray-800 border border-stone-300 dark:border-gray-700 border-t-0 rounded-b-sm shadow-lg px-8 py-3">
						<div class="flex justify-center">
							<span class="text-sm text-stone-400 dark:text-gray-500 font-serif">— ✝ —</span>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- Dialog para mostrar comentarios -->
		<dialog id="commentDialog" class="p-0 rounded-lg shadow-2xl backdrop:bg-black/60 max-w-xl w-full mx-4 bg-amber-50 dark:bg-gray-800 border border-stone-300 dark:border-gray-600">
			<div class="rounded-lg">
				<div class="flex justify-between items-center p-4 border-b border-stone-200 dark:border-gray-700 bg-amber-100/50 dark:bg-gray-700/50 rounded-t-lg">
					<h3 id="commentTitle" class="text-lg font-bold text-gray-800 dark:text-gray-100 font-serif">Comentario</h3>
					<button id="closeCommentDialog" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl leading-none">&times;</button>
				</div>
				<div id="commentContent" class="p-5 max-h-[60vh] overflow-y-auto text-gray-700 dark:text-gray-300 font-serif leading-relaxed text-sm">
					<!-- Contenido dinámico -->
				</div>
				<div class="p-3 border-t border-stone-200 dark:border-gray-700 bg-amber-100/30 dark:bg-gray-700/30 rounded-b-lg">
					<button id="closeCommentBtn" class="w-full px-4 py-2 bg-amber-700 dark:bg-amber-600 text-white rounded hover:bg-amber-800 dark:hover:bg-amber-700 transition text-sm">
						Cerrar
					</button>
				</div>
			</div>
		</dialog>
	</div>
</Layout>

<style>
	/* Scrollbar estilos */
	aside::-webkit-scrollbar,
	main::-webkit-scrollbar {
		width: 6px;
	}
	aside::-webkit-scrollbar-track,
	main::-webkit-scrollbar-track {
		background: #f5f5f4;
	}
	aside::-webkit-scrollbar-thumb,
	main::-webkit-scrollbar-thumb {
		background: #d6d3d1;
		border-radius: 3px;
	}
	aside::-webkit-scrollbar-thumb:hover,
	main::-webkit-scrollbar-thumb:hover {
		background: #a8a29e;
	}

	/* Dark mode scrollbar */
	:global(.dark) aside::-webkit-scrollbar-track,
	:global(.dark) main::-webkit-scrollbar-track {
		background: #1f2937;
	}
	:global(.dark) aside::-webkit-scrollbar-thumb,
	:global(.dark) main::-webkit-scrollbar-thumb {
		background: #4b5563;
	}
	:global(.dark) aside::-webkit-scrollbar-thumb:hover,
	:global(.dark) main::-webkit-scrollbar-thumb:hover {
		background: #6b7280;
	}

	/* Contenido de la biblia - página con dos columnas */
	.bible-content {
		padding: 0;
		font-family: "Times New Roman", Times, serif;
	}

	/* Cada página es un contenedor */
	.bible-content :global(.bible-page-content) {
		padding: 2rem 2.5rem;
		position: relative;
	}

	@media (min-width: 768px) {
		.bible-content :global(.bible-page-content) {
			padding: 2.5rem 3rem;
		}
	}

	/* Contenedor de columnas CSS - permite que el texto fluya naturalmente */
	.bible-content :global(.bible-columns-wrapper) {
		columns: 2;
		column-gap: 3rem;
		column-rule: 1px solid #d6d3d1;
		min-height: 700px;
		text-align: justify;
	}

	:global(.dark) .bible-content :global(.bible-columns-wrapper) {
		column-rule-color: #374151;
	}

	/* Evitar que los encabezados se queden solos al final de una columna */
	.bible-content :global(.bible-columns-wrapper h2),
	.bible-content :global(.bible-columns-wrapper h3) {
		break-after: avoid;
	}

	/* Responsive: una columna en móvil */
	@media (max-width: 768px) {
		.bible-content :global(.bible-columns-wrapper) {
			columns: 1;
			column-rule: none;
			min-height: auto;
		}
	}

	/* Estilos para marcadores de capítulo */
	.bible-content :global(.chapter-marker) {
		font-size: 2rem;
		font-weight: 700;
		color: #374151;
		float: left;
		line-height: 1;
		margin-right: 0.25rem;
		margin-top: 0.1rem;
		padding-right: 0.15rem;
		font-family: "Times New Roman", Times, serif;
	}

	:global(.dark) .bible-content :global(.chapter-marker) {
		color: #e5e7eb;
	}

	/* Estilos para versículos en superíndice */
	.bible-content :global(sup) {
		font-size: 0.6em;
		vertical-align: super;
		line-height: 0;
		color: #4b5563;
		font-weight: 600;
		margin-right: 1px;
	}

	:global(.dark) .bible-content :global(sup) {
		color: #9ca3af;
	}

	/* Párrafos */
	.bible-content :global(p) {
		text-align: justify;
		line-height: 1.7;
		font-size: 0.9rem;
		margin-bottom: 0.75rem;
		font-family: "Times New Roman", Times, serif;
	}

	/* Divisor de página */
	.bible-content :global(.page-divider) {
		grid-column: 1 / -1;
		width: 100%;
		height: 30px;
		margin: 1rem 0;
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		background: linear-gradient(to bottom,
			#fffbeb,
			#f5f0e1 45%,
			#d6d3d1 50%,
			#f5f0e1 55%,
			#fffbeb
		);
	}

	:global(.dark) .bible-content :global(.page-divider) {
		background: linear-gradient(to bottom,
			#1f2937,
			#263243 45%,
			#374151 50%,
			#263243 55%,
			#1f2937
		);
	}

	.bible-content :global(.page-divider)::before {
		content: '';
		position: absolute;
		left: 10%;
		right: 10%;
		top: 50%;
		height: 1px;
		background: #a8a29e;
		transform: translateY(-50%);
	}

	:global(.dark) .bible-content :global(.page-divider)::before {
		background: #4b5563;
	}

	:global(.bible-content .page-divider span) {
		position: relative;
		z-index: 1;
		background: #fffbeb;
		padding: 0 1rem;
		color: #78716c;
		font-size: 0.7rem;
		font-family: "Times New Roman", Times, serif;
	}

	:global(.dark .bible-content .page-divider span) {
		background: #1f2937;
		color: #6b7280;
	}


	/* Estilos para secciones contraíbles del sidebar */
	.section-content {
		overflow: hidden;
		transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
		max-height: 1000px;
		opacity: 1;
	}

	.section-content.collapsed {
		max-height: 0;
		opacity: 0;
	}

	.toggle-icon {
		transition: transform 0.3s ease;
	}

	.toggle-icon.rotated {
		transform: rotate(-90deg);
	}

	/* Sombras laterales del libro */
	.bible-book {
		position: relative;
	}

	.bible-content::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 20px;
		background: linear-gradient(to right, rgba(0,0,0,0.05), transparent);
		pointer-events: none;
	}

	.bible-content::after {
		content: '';
		position: absolute;
		right: 0;
		top: 0;
		bottom: 0;
		width: 20px;
		background: linear-gradient(to left, rgba(0,0,0,0.05), transparent);
		pointer-events: none;
	}
	/* Estilos para secciones introductorias */
	.bible-content :global(.section-intro) {
		display: block;
		font-style: italic;
		text-align: center;
		font-size: 1.1rem;
		color: #3f444d;
		margin: 0.75rem 0 0.5rem 0;
		font-weight: 500;
		letter-spacing: 0.025em;
		line-height: 1.3;
	}

	:global(.dark) .bible-content :global(.section-intro) {
		color: #9ca3af;
	}

	/* Subtítulos de subsección centrados */
	.bible-content :global(h2 .subsection-title) {
		display: block;
		text-align: center;
		font-weight: 600;
		color: #374151;
		letter-spacing: 0.05em;
		margin: 0.25rem 0;
		line-height: 1.2;
	}

	:global(.dark) .bible-content :global(h2 .subsection-title) {
		color: #e5e7eb;
	}

	/* Referencias paralelas - con indentación y números de capítulo en negrita */
	.bible-content :global(.parallel-ref) {
		display: block;
		font-family: "Times New Roman", Times, serif;
		font-size: 0.85rem;
		color: #4b5563;
		margin: 0.1rem 0 0.1rem 1.5rem;
		padding-left: 0.5rem;
		line-height: 1.3;
		font-weight: 400;
		break-inside: avoid;
	}

	:global(.dark) .bible-content :global(.parallel-ref) {
		color: #9ca3af;
	}

	/* Números de capítulo en negrita dentro de paralelos */
	.bible-content :global(.parallel-ref strong) {
		font-weight: 700;
		color: #374151;
	}

	:global(.dark) .bible-content :global(.parallel-ref strong) {
		color: #e5e7eb;
	}
	/* Título principal del libro (h1) - más pequeño y centrado */
	.bible-content :global(h1) {
		text-align: center;
		font-size: 1.5rem;
		font-weight: 700;
		color: #1f2937;
		margin: 0.5rem 0 0.25rem 0;
		letter-spacing: 0.1em;
		text-transform: uppercase;
		line-height: 1.2;
	}

	:global(.dark) .bible-content :global(h1) {
		color: #f3f4f6;
	}

	@media (min-width: 768px) {
		.bible-content :global(h1) {
			font-size: 1.75rem;
		}
	}
	/* Reducir margen de TODOS los h2 */
	.bible-content :global(h2) {
		margin-top: 0.5rem; /* Reducido desde el valor por defecto de prose */
		margin-bottom: 0.25rem; /* Reducido */
		line-height: 1.3; /* Agregado */
	}

	/* También puedes sobrescribir los estilos de prose que vienen de Tailwind */
	.bible-content {
		--tw-prose-headings: inherit;
	}

	/* Sobrescribir estilos específicos de prose para h2 */
	.bible-content :global(h2) {
		margin-top: 0.5rem !important;
		margin-bottom: 0.25rem !important;
	}

	/* Estilos para notas al pie (asteriscos clicables) */
	.bible-content :global(.note-ref) {
		color: #b45309;
		cursor: pointer;
		font-weight: 700;
		font-size: 1em;
		transition: color 0.2s;
		display: inline;
		user-select: none;
		padding: 0 1px;
		position: relative;
	}

	.bible-content :global(.note-ref:hover) {
		color: #92400e;
		text-decoration: underline;
	}

	:global(.dark) .bible-content :global(.note-ref) {
		color: #fbbf24;
	}

	:global(.dark) .bible-content :global(.note-ref:hover) {
		color: #fcd34d;
		text-decoration: underline;
	}

	/* Dialog de comentarios */
	#commentDialog::backdrop {
		background: rgba(0, 0, 0, 0.6);
	}

	#commentDialog[open] {
		animation: dialogFadeIn 0.2s ease-out;
	}

	@keyframes dialogFadeIn {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}
</style>

<script define:vars={{ slug }}>
	const STORAGE_KEY = 'biblia-sidebar-sections';
	const currentSlug = slug;

	// Obtener la sección actual basada en el slug del libro
	function getCurrentSection() {
		const parts = currentSlug.split('/');
		if (parts.length >= 2) {
			return `${parts[0]}-${parts[1]}`;
		}
		return null;
	}

	// Cargar estado guardado de las secciones
	function loadSectionState() {
		try {
			const saved = localStorage.getItem(STORAGE_KEY);
			return saved ? JSON.parse(saved) : {};
		} catch {
			return {};
		}
	}

	// Guardar estado de las secciones
	function saveSectionState(state) {
		try {
			localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
		} catch {
			// Ignorar errores de localStorage
		}
	}

	// Inicializar las secciones contraíbles
	function initSectionToggles() {
		const toggleButtons = document.querySelectorAll('.section-toggle');
		const sectionState = loadSectionState();
		const currentSection = getCurrentSection();

		toggleButtons.forEach(button => {
			const sectionId = button.getAttribute('data-section');
			if (!sectionId) return;

			const content = document.querySelector(`.section-content[data-section="${sectionId}"]`);
			const icon = button.querySelector('.toggle-icon');

			if (!content) return;

			// Determinar si la sección debe estar colapsada
			// Si es la sección actual, siempre expandida
			// Si no hay estado guardado, por defecto expandida
			// Si hay estado guardado, usar ese estado
			let isCollapsed = false;

			if (sectionId === currentSection) {
				// La sección del libro actual siempre expandida
				isCollapsed = false;
				sectionState[sectionId] = false; // Guardar como expandida
			} else if (sectionState.hasOwnProperty(sectionId)) {
				isCollapsed = sectionState[sectionId];
			}

			// Aplicar estado inicial
			if (isCollapsed) {
				content.classList.add('collapsed');
				icon?.classList.add('rotated');
			} else {
				content.classList.remove('collapsed');
				icon?.classList.remove('rotated');
			}

			// Manejar clic para toggle
			button.addEventListener('click', () => {
				const isCurrentlyCollapsed = content.classList.contains('collapsed');

				if (isCurrentlyCollapsed) {
					content.classList.remove('collapsed');
					icon?.classList.remove('rotated');
					sectionState[sectionId] = false;
				} else {
					content.classList.add('collapsed');
					icon?.classList.add('rotated');
					sectionState[sectionId] = true;
				}

				saveSectionState(sectionState);
			});
		});

		// Guardar el estado inicial
		saveSectionState(sectionState);
	}

	// Scroll al libro activo en el sidebar
	function scrollToActiveBook() {
		const activeLink = document.querySelector('.bg-amber-200');
		if (activeLink) {
			// Esperar un poco para que el DOM esté listo
			setTimeout(() => {
				activeLink.scrollIntoView({ block: 'center', behavior: 'instant' });
			}, 100);
		}
	}

	// Menú móvil
	const menuToggle = document.getElementById('menuToggle');
	const sidebar = document.getElementById('sidebar');
	const overlay = document.getElementById('sidebarOverlay');
	const menuIcon = document.getElementById('menuIcon');
	const closeIcon = document.getElementById('closeIcon');

	let isOpen = false;

	function toggleMenu() {
		isOpen = !isOpen;

		if (isOpen) {
			sidebar?.classList.remove('-translate-x-full');
			sidebar?.classList.add('translate-x-0');
			overlay?.classList.remove('hidden');
			menuIcon?.classList.add('hidden');
			closeIcon?.classList.remove('hidden');
		} else {
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	}

	menuToggle?.addEventListener('click', toggleMenu);
	overlay?.addEventListener('click', toggleMenu);

	// Cerrar menú al hacer click en un enlace (móvil)
	sidebar?.querySelectorAll('a').forEach(link => {
		link.addEventListener('click', () => {
			if (window.innerWidth < 768 && isOpen) {
				toggleMenu();
			}
		});
	});

	// Cerrar menú al cambiar tamaño de ventana a desktop
	window.addEventListener('resize', () => {
		if (window.innerWidth >= 768 && isOpen) {
			isOpen = false;
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	});

	// Dark mode
	const DARK_MODE_KEY = 'biblia-dark-mode';
	const darkModeToggle = document.getElementById('darkModeToggle');
	const sunIcon = document.getElementById('sunIcon');
	const moonIcon = document.getElementById('moonIcon');

	function isDarkMode() {
		const saved = localStorage.getItem(DARK_MODE_KEY);
		if (saved !== null) {
			return saved === 'true';
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches;
	}

	function updateDarkModeUI(isDark) {
		if (isDark) {
			document.documentElement.classList.add('dark');
			sunIcon?.classList.remove('hidden');
			moonIcon?.classList.add('hidden');
		} else {
			document.documentElement.classList.remove('dark');
			sunIcon?.classList.add('hidden');
			moonIcon?.classList.remove('hidden');
		}
	}

	function toggleDarkMode() {
		const isDark = document.documentElement.classList.contains('dark');
		const newMode = !isDark;
		localStorage.setItem(DARK_MODE_KEY, String(newMode));
		updateDarkModeUI(newMode);
	}

	// Inicializar dark mode
	updateDarkModeUI(isDarkMode());

	darkModeToggle?.addEventListener('click', toggleDarkMode);

	// Organizar contenido en páginas con dos columnas usando CSS columns
	function organizeBiblePages() {
		const bibleContent = document.querySelector('.bible-content');
		if (!bibleContent) return;

		// Guardar el contenido original
		const originalHTML = bibleContent.innerHTML;
		if (!originalHTML.trim()) return;

		// Limpiar y reorganizar
		bibleContent.innerHTML = '';

		const PAGE_HEIGHT = 750; // Altura de cada página en px

		// Crear contenedor temporal para medir
		const tempContainer = document.createElement('div');
		tempContainer.style.cssText = 'position:absolute;visibility:hidden;width:' + (bibleContent.offsetWidth || 800) + 'px;';
		tempContainer.innerHTML = originalHTML;
		document.body.appendChild(tempContainer);

		// Obtener todos los elementos
		const allElements = Array.from(tempContainer.children);
		document.body.removeChild(tempContainer);

		let pageNumber = 1;

		function createPage() {
			if (pageNumber > 1) {
				// Agregar divisor entre páginas
				const divider = document.createElement('div');
				divider.className = 'page-divider';
				divider.innerHTML = `<span>— Página ${pageNumber} —</span>`;
				bibleContent.appendChild(divider);
			}

			const page = document.createElement('div');
			page.className = 'bible-page-content';

			// Contenedor interno que usará CSS columns
			const columnsContainer = document.createElement('div');
			columnsContainer.className = 'bible-columns-wrapper';
			page.appendChild(columnsContainer);

			bibleContent.appendChild(page);
			pageNumber++;

			return columnsContainer;
		}

		// Crear primera página
		let currentContainer = createPage();
		let currentHeight = 0;

		// Agregar elementos midiendo alturas
		allElements.forEach(el => {
			const clone = el.cloneNode(true);
			currentContainer.appendChild(clone);

			// Medir altura del contenedor (con columnas CSS, el contenido se distribuye)
			const containerHeight = currentContainer.offsetHeight;

			// Si excede la altura de página, crear nueva página
			if (containerHeight > PAGE_HEIGHT) {
				// Remover el elemento que causó el overflow
				currentContainer.removeChild(clone);

				// Crear nueva página
				currentContainer = createPage();

				// Agregar a la nueva página
				currentContainer.appendChild(clone);
			}
		});
	}

	// Inicializar todo
	initSectionToggles();
	scrollToActiveBook();

	// Organizar páginas después de que el contenido esté listo
	setTimeout(organizeBiblePages, 150);

	// ========================================
	// Sistema de comentarios (notas al pie)
	// ========================================
	const commentDialog = document.getElementById('commentDialog');
	const commentTitle = document.getElementById('commentTitle');
	const commentContent = document.getElementById('commentContent');
	const closeCommentDialog = document.getElementById('closeCommentDialog');
	const closeCommentBtn = document.getElementById('closeCommentBtn');

	// Cerrar dialog
	closeCommentDialog?.addEventListener('click', () => commentDialog?.close());
	closeCommentBtn?.addEventListener('click', () => commentDialog?.close());
	commentDialog?.addEventListener('click', (e) => {
		if (e.target === commentDialog) commentDialog.close();
	});

	// Manejar clics en asteriscos de notas
	function initNoteRefs() {
		document.querySelectorAll('.note-ref').forEach(noteRef => {
			noteRef.addEventListener('click', async (e) => {
				e.preventDefault();
				const ref = (e.target).dataset.ref;
				if (!ref) return;

				// Mostrar loading
				if (commentTitle) commentTitle.textContent = 'Cargando...';
				if (commentContent) commentContent.innerHTML = '<div class="text-center py-4"><span class="animate-pulse">Cargando comentario...</span></div>';
				commentDialog?.showModal();

				try {
					const response = await fetch('/api/get-comment', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ ref, bookSlug: currentSlug })
					});

					const data = await response.json();

					if (response.ok && data.success) {
						if (commentTitle) commentTitle.textContent = data.title;
						if (commentContent) commentContent.innerHTML = `<p>${data.comment}</p>`;
					} else {
						if (commentTitle) commentTitle.textContent = 'Comentario no disponible';
						if (commentContent) commentContent.innerHTML = `
							<div class="text-center py-4 text-gray-500">
								<p>No se encontró el comentario para esta referencia.</p>
								<p class="text-xs mt-2 font-mono">${ref}</p>
							</div>
						`;
					}
				} catch (error) {
					console.error('Error al obtener comentario:', error);
					if (commentTitle) commentTitle.textContent = 'Error';
					if (commentContent) commentContent.innerHTML = '<p class="text-red-500">Error al cargar el comentario.</p>';
				}
			});
		});
	}

	// Inicializar después de que se organicen las páginas
	setTimeout(initNoteRefs, 200);

	// Re-inicializar si el contenido se reorganiza
	const observer = new MutationObserver(() => {
		setTimeout(initNoteRefs, 100);
	});
	const bibleContent = document.querySelector('.bible-content');
	if (bibleContent) {
		observer.observe(bibleContent, { childList: true, subtree: true });
	}
</script>
