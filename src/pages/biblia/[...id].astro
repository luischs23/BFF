---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export const prerender = true;

export async function getStaticPaths() {
    const libros = await getCollection("sagrada-biblia");

    return libros.map((book) => ({
        params: { id: book.slug },
        props: { book }
    }));
}

const { id } = Astro.params;
const { book } = Astro.props;

if (!book) {
    return Astro.redirect('/404');
}

const { data, slug, render } = book;
const { title } = data;
const { Content } = await render();

// Obtener todos los libros para el sidebar
const libros = await getCollection('sagrada-biblia');

// Organizar libros por sección
const estructura = {
	'antiguo-testamento': {
		titulo: 'Antiguo Testamento',
		secciones: {
			'01-pentateuco': { titulo: 'El Pentateuco', libros: [] as any[] },
			'02-libros-historicos': { titulo: 'Libros Históricos', libros: [] as any[] },
			'03-lirica': { titulo: 'Lírica', libros: [] as any[] },
			'04-libros-sapienciales': { titulo: 'Libros Sapienciales', libros: [] as any[] },
			'05-libros-profeticos': { titulo: 'Libros Proféticos', libros: [] as any[] },
		}
	},
	'nuevo-testamento': {
		titulo: 'Nuevo Testamento',
		secciones: {
			'01-evangelios': { titulo: 'Evangelios', libros: [] as any[] },
			'02-hechos': { titulo: 'Hechos', libros: [] as any[] },
			'03-epistolas-pablo': { titulo: 'Epístolas de Pablo', libros: [] as any[] },
			'04-hebreos': { titulo: 'Hebreos', libros: [] as any[] },
			'05-epistolas-catolicas': { titulo: 'Epístolas Católicas', libros: [] as any[] },
			'06-apocalipsis': { titulo: 'Apocalipsis', libros: [] as any[] },
		}
	}
};

libros.forEach(libro => {
	const slugParts = libro.slug.split('/');
	if (slugParts.length >= 2) {
		const testamento = slugParts[0] as keyof typeof estructura;
		const seccion = slugParts[1] as keyof typeof estructura[typeof testamento]['secciones'];
		if (estructura[testamento]?.secciones?.[seccion]) {
			(estructura[testamento].secciones as any)[seccion].libros.push(libro);
		}
	}
});

Object.values(estructura).forEach(testamento => {
	Object.values(testamento.secciones).forEach(seccion => {
		seccion.libros.sort((a, b) => a.slug.localeCompare(b.slug));
	});
});
---

<Layout title={`${title} - Sagrada Biblia`}>
	<div id="bibliaContainer" class="flex h-screen relative bg-amber-50/70 dark:bg-gray-900 transition-colors duration-300">
		<!-- Overlay para móvil -->
		<div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

		<!-- Botón menú móvil -->
		<button
			id="menuToggle"
			class="md:hidden fixed top-20 left-4 z-50 bg-amber-700 text-white p-3 rounded-lg shadow-lg hover:bg-amber-800 transition"
			aria-label="Abrir menú"
		>
			<svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
			<svg id="closeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
			</svg>
		</button>

		<!-- Sidebar -->
		<aside
			id="sidebar"
			class="fixed md:relative w-72 h-full bg-stone-100 dark:bg-gray-800 border-r border-stone-200 dark:border-gray-700 overflow-y-auto flex-shrink-0 z-50 transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out"
		>
			<div class="p-4">
				<div class="flex items-center justify-between mb-4">
					<a href="/" class="text-amber-700 dark:text-amber-400 hover:underline text-sm">&larr; Inicio</a>
					<button
						id="darkModeToggle"
						class="p-2 rounded-lg bg-stone-200 dark:bg-gray-700 hover:bg-stone-300 dark:hover:bg-gray-600 transition-colors"
						aria-label="Cambiar tema"
					>
						<!-- Sol (modo claro) -->
						<svg id="sunIcon" class="w-5 h-5 text-amber-600 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
						</svg>
						<!-- Luna (modo oscuro) -->
						<svg id="moonIcon" class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
						</svg>
					</button>
				</div>
				<h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Sagrada Biblia</h2>

				{Object.entries(estructura).map(([testamentoKey, testamento]) => (
					<div class="mb-6">
						<h3 class="font-bold text-gray-800 dark:text-gray-200 mb-2 text-sm uppercase tracking-wide">
							{testamento.titulo}
						</h3>

						{Object.entries(testamento.secciones).map(([seccionKey, seccion]) => (
							seccion.libros.length > 0 && (
								<div class="mb-3">
									<button
										class="section-toggle w-full flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 pl-2 pr-2 py-1 hover:bg-stone-200 dark:hover:bg-gray-700 rounded transition"
										data-section={`${testamentoKey}-${seccionKey}`}
									>
										<span>{seccion.titulo}</span>
										<svg class="toggle-icon w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
										</svg>
									</button>
									<ul class="section-content space-y-1" data-section={`${testamentoKey}-${seccionKey}`}>
										{seccion.libros.filter(libro => !libro.data.isIntro).map(libro => (
											<li>
												<a
													href={`/biblia/${libro.slug}`}
													class:list={[
														"block px-3 py-1.5 text-sm rounded transition",
														libro.slug === slug
															? "bg-amber-200 dark:bg-amber-700 text-amber-900 dark:text-amber-100 font-semibold"
															: "text-gray-600 dark:text-gray-300 hover:bg-amber-100 dark:hover:bg-gray-700 hover:text-amber-800 dark:hover:text-amber-300"
													]}
												>
													{libro.data.title}
												</a>
											</li>
										))}
									</ul>
								</div>
							)
						))}
					</div>
				))}
			</div>
		</aside>

		<!-- Contenido principal -->
		<main class="flex-1 overflow-y-auto bg-amber-50/50 dark:bg-gray-900 transition-colors duration-300">
			<div class="p-4 md:p-8 max-w-3xl mx-auto pt-16 md:pt-8">
				<article class="bible-content prose prose-base max-w-none
					prose-headings:text-gray-800 dark:prose-headings:text-gray-100
					prose-h1:text-xl md:prose-h1:text-2xl prose-h1:font-bold
					prose-h2:text-base md:prose-h2:text-lg prose-h2:border-b prose-h2:border-stone-300 dark:prose-h2:border-gray-700 prose-h2:pb-2 prose-h2:mt-6
					prose-p:text-gray-700 dark:prose-p:text-gray-300
					dark:prose-invert">
					<h1>{title}</h1>
					<Content />
				</article>
			</div>
		</main>
	</div>
</Layout>

<style>
	/* Scrollbar estilos */
	aside::-webkit-scrollbar,
	main::-webkit-scrollbar {
		width: 6px;
	}
	aside::-webkit-scrollbar-track,
	main::-webkit-scrollbar-track {
		background: #f5f5f4;
	}
	aside::-webkit-scrollbar-thumb,
	main::-webkit-scrollbar-thumb {
		background: #d6d3d1;
		border-radius: 3px;
	}
	aside::-webkit-scrollbar-thumb:hover,
	main::-webkit-scrollbar-thumb:hover {
		background: #a8a29e;
	}

	/* Dark mode scrollbar */
	:global(.dark) aside::-webkit-scrollbar-track,
	:global(.dark) main::-webkit-scrollbar-track {
		background: #1f2937;
	}
	:global(.dark) aside::-webkit-scrollbar-thumb,
	:global(.dark) main::-webkit-scrollbar-thumb {
		background: #4b5563;
	}
	:global(.dark) aside::-webkit-scrollbar-thumb:hover,
	:global(.dark) main::-webkit-scrollbar-thumb:hover {
		background: #6b7280;
	}

	/* Estilos para marcadores de capítulo */
	.bible-content :global(.chapter-marker) {
		font-size: 2rem;
		font-weight: 700;
		color: #374151;
		float: left;
		line-height: 1;
		margin-right: 0.25rem;
		margin-top: 0.1rem;
		padding-right: 0.25rem;
	}

	:global(.dark) .bible-content :global(.chapter-marker) {
		color: #e5e7eb;
	}

	/* Estilos para versículos en superíndice */
	.bible-content :global(sup) {
		font-size: 0.65em;
		vertical-align: super;
		line-height: 0;
		color: #4b5563;
		font-weight: 600;
		margin-right: 2px;
	}

	:global(.dark) .bible-content :global(sup) {
		color: #9ca3af;
	}

	.bible-content :global(p) {
		text-align: justify;
		line-height: 1.75;
		font-size: 0.95rem;
	}

	/* Estilos para secciones contraíbles */
	.section-content {
		overflow: hidden;
		transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
		max-height: 1000px;
		opacity: 1;
	}

	.section-content.collapsed {
		max-height: 0;
		opacity: 0;
	}

	.toggle-icon {
		transition: transform 0.3s ease;
	}

	.toggle-icon.rotated {
		transform: rotate(-90deg);
	}
</style>

<script define:vars={{ slug }}>
	const STORAGE_KEY = 'biblia-sidebar-sections';
	const currentSlug = slug;

	// Obtener la sección actual basada en el slug del libro
	function getCurrentSection() {
		const parts = currentSlug.split('/');
		if (parts.length >= 2) {
			return `${parts[0]}-${parts[1]}`;
		}
		return null;
	}

	// Cargar estado guardado de las secciones
	function loadSectionState() {
		try {
			const saved = localStorage.getItem(STORAGE_KEY);
			return saved ? JSON.parse(saved) : {};
		} catch {
			return {};
		}
	}

	// Guardar estado de las secciones
	function saveSectionState(state) {
		try {
			localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
		} catch {
			// Ignorar errores de localStorage
		}
	}

	// Inicializar las secciones contraíbles
	function initSectionToggles() {
		const toggleButtons = document.querySelectorAll('.section-toggle');
		const sectionState = loadSectionState();
		const currentSection = getCurrentSection();

		toggleButtons.forEach(button => {
			const sectionId = button.getAttribute('data-section');
			if (!sectionId) return;

			const content = document.querySelector(`.section-content[data-section="${sectionId}"]`);
			const icon = button.querySelector('.toggle-icon');

			if (!content) return;

			// Determinar si la sección debe estar colapsada
			// Si es la sección actual, siempre expandida
			// Si no hay estado guardado, por defecto expandida
			// Si hay estado guardado, usar ese estado
			let isCollapsed = false;

			if (sectionId === currentSection) {
				// La sección del libro actual siempre expandida
				isCollapsed = false;
				sectionState[sectionId] = false; // Guardar como expandida
			} else if (sectionState.hasOwnProperty(sectionId)) {
				isCollapsed = sectionState[sectionId];
			}

			// Aplicar estado inicial
			if (isCollapsed) {
				content.classList.add('collapsed');
				icon?.classList.add('rotated');
			} else {
				content.classList.remove('collapsed');
				icon?.classList.remove('rotated');
			}

			// Manejar clic para toggle
			button.addEventListener('click', () => {
				const isCurrentlyCollapsed = content.classList.contains('collapsed');

				if (isCurrentlyCollapsed) {
					content.classList.remove('collapsed');
					icon?.classList.remove('rotated');
					sectionState[sectionId] = false;
				} else {
					content.classList.add('collapsed');
					icon?.classList.add('rotated');
					sectionState[sectionId] = true;
				}

				saveSectionState(sectionState);
			});
		});

		// Guardar el estado inicial
		saveSectionState(sectionState);
	}

	// Scroll al libro activo en el sidebar
	function scrollToActiveBook() {
		const activeLink = document.querySelector('.bg-amber-200');
		if (activeLink) {
			// Esperar un poco para que el DOM esté listo
			setTimeout(() => {
				activeLink.scrollIntoView({ block: 'center', behavior: 'instant' });
			}, 100);
		}
	}

	// Menú móvil
	const menuToggle = document.getElementById('menuToggle');
	const sidebar = document.getElementById('sidebar');
	const overlay = document.getElementById('sidebarOverlay');
	const menuIcon = document.getElementById('menuIcon');
	const closeIcon = document.getElementById('closeIcon');

	let isOpen = false;

	function toggleMenu() {
		isOpen = !isOpen;

		if (isOpen) {
			sidebar?.classList.remove('-translate-x-full');
			sidebar?.classList.add('translate-x-0');
			overlay?.classList.remove('hidden');
			menuIcon?.classList.add('hidden');
			closeIcon?.classList.remove('hidden');
		} else {
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	}

	menuToggle?.addEventListener('click', toggleMenu);
	overlay?.addEventListener('click', toggleMenu);

	// Cerrar menú al hacer click en un enlace (móvil)
	sidebar?.querySelectorAll('a').forEach(link => {
		link.addEventListener('click', () => {
			if (window.innerWidth < 768 && isOpen) {
				toggleMenu();
			}
		});
	});

	// Cerrar menú al cambiar tamaño de ventana a desktop
	window.addEventListener('resize', () => {
		if (window.innerWidth >= 768 && isOpen) {
			isOpen = false;
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	});

	// Dark mode
	const DARK_MODE_KEY = 'biblia-dark-mode';
	const darkModeToggle = document.getElementById('darkModeToggle');
	const sunIcon = document.getElementById('sunIcon');
	const moonIcon = document.getElementById('moonIcon');

	function isDarkMode() {
		const saved = localStorage.getItem(DARK_MODE_KEY);
		if (saved !== null) {
			return saved === 'true';
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches;
	}

	function updateDarkModeUI(isDark) {
		if (isDark) {
			document.documentElement.classList.add('dark');
			sunIcon?.classList.remove('hidden');
			moonIcon?.classList.add('hidden');
		} else {
			document.documentElement.classList.remove('dark');
			sunIcon?.classList.add('hidden');
			moonIcon?.classList.remove('hidden');
		}
	}

	function toggleDarkMode() {
		const isDark = document.documentElement.classList.contains('dark');
		const newMode = !isDark;
		localStorage.setItem(DARK_MODE_KEY, String(newMode));
		updateDarkModeUI(newMode);
	}

	// Inicializar dark mode
	updateDarkModeUI(isDarkMode());

	darkModeToggle?.addEventListener('click', toggleDarkMode);

	// Inicializar todo
	initSectionToggles();
	scrollToActiveBook();
</script>
