---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const libros = await getCollection('sagrada-biblia');

// Organizar libros por sección
const estructura = {
	'antiguo-testamento': {
		titulo: 'Antiguo Testamento',
		secciones: {
			'01-pentateuco': { titulo: 'El Pentateuco', libros: [] as any[] },
			'02-libros-historicos': { titulo: 'Libros Históricos', libros: [] as any[] },
			'03-lirica': { titulo: 'Lírica', libros: [] as any[] },
			'04-libros-sapienciales': { titulo: 'Libros Sapienciales', libros: [] as any[] },
			'05-libros-profeticos': { titulo: 'Libros Proféticos', libros: [] as any[] },
		}
	},
	'nuevo-testamento': {
		titulo: 'Nuevo Testamento',
		secciones: {
			'01-evangelios': { titulo: 'Evangelios', libros: [] as any[] },
			'02-hechos': { titulo: 'Hechos', libros: [] as any[] },
			'03-epistolas-pablo': { titulo: 'Epístolas de Pablo', libros: [] as any[] },
			'04-hebreos': { titulo: 'Hebreos', libros: [] as any[] },
			'05-epistolas-catolicas': { titulo: 'Epístolas Católicas', libros: [] as any[] },
			'06-apocalipsis': { titulo: 'Apocalipsis', libros: [] as any[] },
		}
	}
};

// Clasificar los libros en sus secciones
libros.forEach(libro => {
	const slugParts = libro.slug.split('/');
	if (slugParts.length >= 2) {
		const testamento = slugParts[0] as keyof typeof estructura;
		const seccion = slugParts[1] as keyof typeof estructura[typeof testamento]['secciones'];

		if (estructura[testamento]?.secciones?.[seccion]) {
			(estructura[testamento].secciones as any)[seccion].libros.push(libro);
		}
	}
});

// Ordenar libros dentro de cada sección
Object.values(estructura).forEach(testamento => {
	Object.values(testamento.secciones).forEach(seccion => {
		seccion.libros.sort((a, b) => a.slug.localeCompare(b.slug));
	});
});
---

<Layout title="Sagrada Biblia">
	<div class="flex h-[calc(100vh-64px)] relative">
		<!-- Overlay para móvil -->
		<div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

		<!-- Botón menú móvil -->
		<button
			id="menuToggle"
			class="md:hidden fixed top-20 left-4 z-50 bg-amber-700 text-white p-3 rounded-lg shadow-lg hover:bg-amber-800 transition"
			aria-label="Abrir menú"
		>
			<svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
			<svg id="closeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
			</svg>
		</button>

		<!-- Sidebar -->
		<aside
			id="sidebar"
			class="fixed md:relative w-72 h-full bg-gray-50 border-r border-gray-200 overflow-y-auto flex-shrink-0 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out"
		>
			<div class="p-4">
				<a href="/" class="text-amber-700 hover:underline text-sm mb-4 block">&larr; Inicio</a>
				<h2 class="text-xl font-bold mb-4">Sagrada Biblia</h2>

				{Object.entries(estructura).map(([_, testamento]) => (
					<div class="mb-6">
						<h3 class="font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide">
							{testamento.titulo}
						</h3>

						{Object.entries(testamento.secciones).map(([__, seccion]) => (
							seccion.libros.length > 0 && (
								<div class="mb-3">
									<h4 class="text-xs font-semibold text-gray-500 mb-1 pl-2">
										{seccion.titulo}
									</h4>
									<ul class="space-y-1">
										{seccion.libros.map(libro => (
											<li>
												<a
													href={`/biblia/${libro.slug}`}
													class="block px-3 py-1.5 text-sm text-gray-700 hover:bg-amber-100 hover:text-amber-800 rounded transition"
												>
													{libro.data.title}
												</a>
											</li>
										))}
									</ul>
								</div>
							)
						))}
					</div>
				))}
			</div>
		</aside>

		<!-- Contenido principal -->
		<main class="flex-1 overflow-y-auto p-4 md:p-8">
			<div class="max-w-3xl mx-auto pt-12 md:pt-0">
				<h1 class="text-3xl md:text-4xl font-bold mb-6">Bienvenido a la Sagrada Biblia</h1>
				<p class="text-gray-600 mb-8">
					<span class="hidden md:inline">Selecciona un libro del menú lateral para comenzar a leer.</span>
					<span class="md:hidden">Toca el botón del menú para seleccionar un libro.</span>
				</p>

				<div class="grid md:grid-cols-2 gap-4 md:gap-6">
					<div class="bg-amber-50 border border-amber-200 rounded-lg p-4 md:p-6">
						<h2 class="text-lg md:text-xl font-bold text-amber-800 mb-2">Antiguo Testamento</h2>
						<p class="text-amber-700 text-sm mb-4">
							Los libros de la antigua alianza, desde el Génesis hasta los Profetas.
						</p>
						<p class="text-xl md:text-2xl font-bold text-amber-800">
							{Object.values(estructura['antiguo-testamento'].secciones)
								.reduce((acc, s) => acc + s.libros.length, 0)} libros disponibles
						</p>
					</div>

					<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 md:p-6">
						<h2 class="text-lg md:text-xl font-bold text-blue-800 mb-2">Nuevo Testamento</h2>
						<p class="text-blue-700 text-sm mb-4">
							Los Evangelios, Hechos, Epístolas y el Apocalipsis.
						</p>
						<p class="text-xl md:text-2xl font-bold text-blue-800">
							{Object.values(estructura['nuevo-testamento'].secciones)
								.reduce((acc, s) => acc + s.libros.length, 0)} libros disponibles
						</p>
					</div>
				</div>
			</div>
		</main>
	</div>
</Layout>

<style>
	aside::-webkit-scrollbar {
		width: 6px;
	}
	aside::-webkit-scrollbar-track {
		background: #f1f1f1;
	}
	aside::-webkit-scrollbar-thumb {
		background: #ccc;
		border-radius: 3px;
	}
	aside::-webkit-scrollbar-thumb:hover {
		background: #aaa;
	}
</style>

<script>
	const menuToggle = document.getElementById('menuToggle');
	const sidebar = document.getElementById('sidebar');
	const overlay = document.getElementById('sidebarOverlay');
	const menuIcon = document.getElementById('menuIcon');
	const closeIcon = document.getElementById('closeIcon');

	let isOpen = false;

	function toggleMenu() {
		isOpen = !isOpen;

		if (isOpen) {
			sidebar?.classList.remove('-translate-x-full');
			sidebar?.classList.add('translate-x-0');
			overlay?.classList.remove('hidden');
			menuIcon?.classList.add('hidden');
			closeIcon?.classList.remove('hidden');
		} else {
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	}

	menuToggle?.addEventListener('click', toggleMenu);
	overlay?.addEventListener('click', toggleMenu);

	// Cerrar menú al hacer click en un enlace (móvil)
	sidebar?.querySelectorAll('a').forEach(link => {
		link.addEventListener('click', () => {
			if (window.innerWidth < 768 && isOpen) {
				toggleMenu();
			}
		});
	});

	// Cerrar menú al cambiar tamaño de ventana a desktop
	window.addEventListener('resize', () => {
		if (window.innerWidth >= 768 && isOpen) {
			isOpen = false;
			sidebar?.classList.add('-translate-x-full');
			sidebar?.classList.remove('translate-x-0');
			overlay?.classList.add('hidden');
			menuIcon?.classList.remove('hidden');
			closeIcon?.classList.add('hidden');
		}
	});
</script>
