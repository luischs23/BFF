---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const libros = await getCollection('sagrada-biblia');

// Organizar libros por secci√≥n (igual que en biblia/index.astro)
const estructura = {
	'antiguo-testamento': {
		titulo: 'Antiguo Testamento',
		color: 'amber',
		secciones: {
			'01-pentateuco': { titulo: 'El Pentateuco', libros: [] as any[] },
			'02-libros-historicos': { titulo: 'Libros Hist√≥ricos', libros: [] as any[] },
			'03-lirica': { titulo: 'L√≠rica', libros: [] as any[] },
			'04-libros-sapienciales': { titulo: 'Libros Sapienciales', libros: [] as any[] },
			'05-libros-profeticos': { titulo: 'Libros Prof√©ticos', libros: [] as any[] },
		}
	},
	'nuevo-testamento': {
		titulo: 'Nuevo Testamento',
		color: 'blue',
		secciones: {
			'01-evangelios': { titulo: 'Evangelios', libros: [] as any[] },
			'02-hechos': { titulo: 'Hechos', libros: [] as any[] },
			'03-epistolas-pablo': { titulo: 'Ep√≠stolas de Pablo', libros: [] as any[] },
			'04-hebreos': { titulo: 'Hebreos', libros: [] as any[] },
			'05-epistolas-catolicas': { titulo: 'Ep√≠stolas Cat√≥licas', libros: [] as any[] },
			'06-apocalipsis': { titulo: 'Apocalipsis', libros: [] as any[] },
		}
	}
};

// Clasificar los libros en sus secciones
libros.forEach(libro => {
	const slugParts = libro.slug.split('/');
	if (slugParts.length >= 2) {
		const testamento = slugParts[0] as keyof typeof estructura;
		const seccion = slugParts[1] as keyof typeof estructura[typeof testamento]['secciones'];

		if (estructura[testamento]?.secciones?.[seccion]) {
			(estructura[testamento].secciones as any)[seccion].libros.push(libro);
		}
	}
});

// Ordenar libros dentro de cada secci√≥n
Object.values(estructura).forEach(testamento => {
	Object.values(testamento.secciones).forEach(seccion => {
		seccion.libros.sort((a, b) => a.slug.localeCompare(b.slug));
	});
});
---

<Layout title="Administrar - Sagrada Biblia">
	<main class="p-4 md:p-8">
		<div class="max-w-screen-xl mx-auto">
			<a href="/" class="text-amber-700 hover:underline text-sm mb-4 block">&larr; Inicio</a>
			<h1 class="text-3xl md:text-4xl font-bold mb-6">Administrar Libros</h1>

			{Object.entries(estructura).map(([testamentoKey, testamento]) => (
				<div class="mb-10">
					<h2 class={`text-2xl font-bold mb-4 pb-2 border-b-2 ${testamentoKey === 'antiguo-testamento' ? 'text-amber-800 border-amber-300' : 'text-blue-800 border-blue-300'}`}>
						{testamento.titulo}
					</h2>

					{Object.entries(testamento.secciones).map(([_, seccion]) => (
						seccion.libros.length > 0 && (
							<div class="mb-6">
								<h3 class="text-lg font-semibold text-gray-700 mb-3 pl-2 border-l-4 border-gray-300">
									{seccion.titulo}
								</h3>
								<div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
									{seccion.libros.map(libro => {
										const { slug, data } = libro;
										const { title } = data;

										return (
											<article class="bg-white border rounded-lg p-3 shadow-sm hover:shadow-md transition">
												<div class="flex items-center justify-between gap-2">
													<h4 class="font-medium text-gray-800 truncate flex-1">{title}</h4>
													<div class="flex gap-1 flex-shrink-0">
														<button
															data-slug={slug}
															class="prepare-btn px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition text-xs"
															title="Preparar (X Y ‚Üí X:Y)"
														>
															P
														</button>
														<button
															data-slug={slug}
															class="format-btn px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-xs"
															title="Formatear (X:Y ‚Üí super√≠ndice)"
														>
															F
														</button>
														<button
															data-slug={slug}
															class="check-btn px-2 py-1 bg-amber-600 text-white rounded hover:bg-amber-700 transition text-xs"
															title="Verificar"
														>
															V
														</button>
														<button
															data-slug={slug}
															class="letter-btn px-2 py-1 bg-pink-600 text-white rounded hover:bg-pink-700 transition text-xs"
															title="Corregir vers√≠culos con letras (47:5a ‚Üí <sup>5a</sup>)"
														>
															L
														</button>
													</div>
												</div>
											</article>
										);
									})}
								</div>
							</div>
						)
					))}
				</div>
			))}
		</div>

		<!-- Dialog para mostrar resultados -->
		<dialog id="consecutiveDialog" class="p-0 rounded-lg shadow-xl backdrop:bg-black/50 max-w-2xl w-full mx-4">
			<div class="bg-white rounded-lg">
				<div class="flex justify-between items-center p-4 border-b">
					<h3 id="dialogTitle" class="text-xl font-bold">Verificaci√≥n de Vers√≠culos</h3>
					<button id="closeDialog" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
				</div>
				<div id="dialogContent" class="p-4 max-h-[60vh] overflow-y-auto">
					<!-- Contenido din√°mico -->
				</div>
				<div class="p-4 border-t bg-gray-50 rounded-b-lg flex gap-2">
					<button id="fixVersesBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition hidden">
						Corregir Vers√≠culos
					</button>
					<button id="closeDialogBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
						Cerrar
					</button>
				</div>
			</div>
		</dialog>
	</main>
</Layout>

<script>
	// Bot√≥n Preparar (P) - Convierte "X Y" a "X:Y" sin super√≠ndice
	document.querySelectorAll('.prepare-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const button = e.target as HTMLButtonElement;
			const slug = button.dataset.slug;
			const originalText = button.textContent;

			button.textContent = '...';
			button.disabled = true;

			try {
				const response = await fetch('/api/prepare-book', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ slug })
				});

				const data = await response.json();

				if (response.ok) {
					button.textContent = '‚úì';
					button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
					button.classList.add('bg-green-600');
					setTimeout(() => {
						button.textContent = originalText;
						button.classList.remove('bg-green-600');
						button.classList.add('bg-purple-600', 'hover:bg-purple-700');
						button.disabled = false;
					}, 2000);
				} else {
					throw new Error(data.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error:', error);
				button.textContent = '‚úó';
				button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
				button.classList.add('bg-red-600');
				setTimeout(() => {
					button.textContent = originalText;
					button.classList.remove('bg-red-600');
					button.classList.add('bg-purple-600', 'hover:bg-purple-700');
					button.disabled = false;
				}, 2000);
			}
		});
	});

	// Bot√≥n Formatear (F) - Convierte "X:Y" a super√≠ndice con marcadores de cap√≠tulo
	document.querySelectorAll('.format-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const button = e.target as HTMLButtonElement;
			const slug = button.dataset.slug;
			const originalText = button.textContent;

			button.textContent = '...';
			button.disabled = true;

			try {
				const response = await fetch('/api/format-book', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ slug })
				});

				const data = await response.json();

				if (response.ok) {
					button.textContent = '‚úì';
					button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
					button.classList.add('bg-green-600');
					setTimeout(() => {
						button.textContent = originalText;
						button.classList.remove('bg-green-600');
						button.classList.add('bg-blue-600', 'hover:bg-blue-700');
						button.disabled = false;
					}, 2000);
				} else {
					throw new Error(data.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error:', error);
				button.textContent = '‚úó';
				button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
				button.classList.add('bg-red-600');
				setTimeout(() => {
					button.textContent = originalText;
					button.classList.remove('bg-red-600');
					button.classList.add('bg-blue-600', 'hover:bg-blue-700');
					button.disabled = false;
				}, 2000);
			}
		});
	});

	const dialog = document.getElementById('consecutiveDialog') as HTMLDialogElement;
	const dialogTitle = document.getElementById('dialogTitle')!;
	const dialogContent = document.getElementById('dialogContent')!;
	const closeDialog = document.getElementById('closeDialog')!;
	const closeDialogBtn = document.getElementById('closeDialogBtn')!;
	const fixVersesBtn = document.getElementById('fixVersesBtn') as HTMLButtonElement;

	let currentSlug = '';

	closeDialog.addEventListener('click', () => dialog.close());
	closeDialogBtn.addEventListener('click', () => dialog.close());
	dialog.addEventListener('click', (e) => {
		if (e.target === dialog) dialog.close();
	});

	fixVersesBtn.addEventListener('click', async () => {
		if (!currentSlug) return;

		const originalText = fixVersesBtn.textContent;
		fixVersesBtn.textContent = 'Corrigiendo...';
		fixVersesBtn.disabled = true;

		try {
			const response = await fetch('/api/fix-verses', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ slug: currentSlug })
			});

			const data = await response.json();

			if (response.ok) {
				dialogContent.innerHTML = `
					<div class="text-center py-8">
						<div class="text-6xl mb-4">‚úÖ</div>
						<p class="text-green-600 font-bold text-lg">¬°Correcci√≥n completada!</p>
						<p class="text-gray-600">${data.message}</p>
					</div>
				`;
				fixVersesBtn.classList.add('hidden');
			} else {
				throw new Error(data.error || 'Error desconocido');
			}
		} catch (error) {
			console.error('Error:', error);
			dialogContent.innerHTML = `
				<div class="text-center py-8">
					<div class="text-6xl mb-4">‚ùå</div>
					<p class="text-red-600 font-bold">Error al corregir</p>
					<p class="text-gray-600">${error instanceof Error ? error.message : 'Error desconocido'}</p>
				</div>
			`;
		} finally {
			fixVersesBtn.textContent = originalText;
			fixVersesBtn.disabled = false;
		}
	});

	// Bot√≥n Letras (L) - Convierte "47:5a" a "<sup>5a</sup>"
	document.querySelectorAll('.letter-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const button = e.target as HTMLButtonElement;
			const slug = button.dataset.slug;
			const originalText = button.textContent;

			button.textContent = '...';
			button.disabled = true;

			try {
				const response = await fetch('/api/fix-letter-verses', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ slug })
				});

				const data = await response.json();

				if (response.ok) {
					button.textContent = '‚úì';
					button.classList.remove('bg-pink-600', 'hover:bg-pink-700');
					button.classList.add('bg-green-600');

					// Mostrar resultado en el dialog
					dialogTitle.textContent = `Vers√≠culos con letras: ${data.book}`;
					if (data.fixed > 0) {
						dialogContent.innerHTML = `
							<div class="text-center py-8">
								<div class="text-6xl mb-4">‚úÖ</div>
								<p class="text-green-600 font-bold text-lg">¬°Correcci√≥n completada!</p>
								<p class="text-gray-600">Se corrigieron ${data.fixed} vers√≠culos con letras</p>
								${data.examples ? `
									<div class="mt-4 text-left bg-gray-50 p-3 rounded max-h-48 overflow-y-auto">
										<p class="text-sm font-bold mb-2">Ejemplos corregidos:</p>
										${data.examples.map((ex: string) => `<p class="text-xs text-gray-600 font-mono">${ex}</p>`).join('')}
									</div>
								` : ''}
							</div>
						`;
					} else {
						dialogContent.innerHTML = `
							<div class="text-center py-8">
								<div class="text-6xl mb-4">üìù</div>
								<p class="text-blue-600 font-bold text-lg">Sin cambios</p>
								<p class="text-gray-600">No se encontraron vers√≠culos con letras para corregir</p>
							</div>
						`;
					}
					fixVersesBtn.classList.add('hidden');
					dialog.showModal();

					setTimeout(() => {
						button.textContent = originalText;
						button.classList.remove('bg-green-600');
						button.classList.add('bg-pink-600', 'hover:bg-pink-700');
						button.disabled = false;
					}, 2000);
				} else {
					throw new Error(data.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error:', error);
				button.textContent = '‚úó';
				button.classList.remove('bg-pink-600', 'hover:bg-pink-700');
				button.classList.add('bg-red-600');
				setTimeout(() => {
					button.textContent = originalText;
					button.classList.remove('bg-red-600');
					button.classList.add('bg-pink-600', 'hover:bg-pink-700');
					button.disabled = false;
				}, 2000);
			}
		});
	});

	document.querySelectorAll('.check-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const button = e.target as HTMLButtonElement;
			const slug = button.dataset.slug;
			currentSlug = slug || '';
			const originalText = button.textContent;

			button.textContent = '...';
			button.disabled = true;
			fixVersesBtn.classList.add('hidden');

			try {
				const response = await fetch('/api/check-consecutive', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ slug })
				});

				const data = await response.json();

				if (response.ok) {
					dialogTitle.textContent = `Verificaci√≥n: ${data.book}`;

					let html = '';

					if (data.missingVerses.length > 0) {
						html += `
							<div class="mb-6">
								<h4 class="font-bold text-red-600 mb-2">
									Vers√≠culos faltantes (${data.missingVerses.length})
								</h4>
								<div class="bg-red-50 border border-red-200 rounded p-3 max-h-48 overflow-y-auto">
									${data.missingVerses.map((v: any) => `
										<div class="text-sm">
											<span class="font-mono font-bold text-red-700">${v.chapter}:${v.verse}</span>
											<span class="text-gray-600 ml-2">${v.context}</span>
										</div>
									`).join('')}
								</div>
							</div>
						`;
					}

					if (data.unformattedVerses.length > 0) {
						html += `
							<div class="mb-6">
								<h4 class="font-bold text-amber-600 mb-2">
									Vers√≠culos sin formatear (${data.unformattedVerses.length})
								</h4>
								<div class="bg-amber-50 border border-amber-200 rounded p-3 max-h-48 overflow-y-auto">
									${data.unformattedVerses.map((v: any) => `
										<div class="text-sm border-b border-amber-100 pb-2 last:border-0">
											<span class="font-mono text-amber-700">L√≠nea ${v.line}:</span>
											<span class="text-gray-700 ml-2">${v.text}</span>
										</div>
									`).join('')}
								</div>
							</div>
						`;
					}

					if (data.missingVerses.length === 0 && data.unformattedVerses.length === 0) {
						html = `
							<div class="text-center py-8">
								<div class="text-6xl mb-4">‚úÖ</div>
								<p class="text-green-600 font-bold text-lg">¬°Todo en orden!</p>
								<p class="text-gray-600">Total de cap√≠tulos: ${data.totalChapters}</p>
							</div>
						`;
					} else {
						if (data.unformattedVerses.length > 0) {
							fixVersesBtn.classList.remove('hidden');
						}
					}

					dialogContent.innerHTML = html;
					dialog.showModal();
				} else {
					throw new Error(data.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error:', error);
				dialogTitle.textContent = 'Error';
				dialogContent.innerHTML = `
					<div class="text-center py-8">
						<div class="text-6xl mb-4">‚ùå</div>
						<p class="text-red-600 font-bold">${error instanceof Error ? error.message : 'Error desconocido'}</p>
					</div>
				`;
				dialog.showModal();
			} finally {
				button.textContent = originalText;
				button.disabled = false;
			}
		});
	});
</script>
