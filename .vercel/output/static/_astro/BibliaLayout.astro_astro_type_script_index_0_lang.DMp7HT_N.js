const B="biblia-sidebar-sections";function D(t){const e=t.split("/");return e.length>=2?`${e[0]}-${e[1]}`:null}function P(){try{const t=localStorage.getItem(B);return t?JSON.parse(t):{}}catch{return{}}}function L(t){try{localStorage.setItem(B,JSON.stringify(t))}catch{}}function H(t){const e=document.querySelectorAll(".section-toggle"),a=P(),n=D(t);e.forEach(s=>{const r=s.getAttribute("data-section");if(!r)return;const c=document.querySelector(`.section-content[data-section="${r}"]`),o=s.querySelector(".toggle-icon");if(!c)return;let l=!1;r===n?(l=!1,a[r]=!1):a.hasOwnProperty(r)&&(l=a[r]),l?(c.classList.add("collapsed"),o?.classList.add("rotated")):(c.classList.remove("collapsed"),o?.classList.remove("rotated")),s.addEventListener("click",()=>{c.classList.contains("collapsed")?(c.classList.remove("collapsed"),o?.classList.remove("rotated"),a[r]=!1):(c.classList.add("collapsed"),o?.classList.add("rotated"),a[r]=!0),L(a)})}),L(a)}function V(){const t=document.querySelector(".bg-amber-200");t&&setTimeout(()=>{t.scrollIntoView({block:"center",behavior:"instant"})},100)}function O(){const t=document.getElementById("menuToggle"),e=document.getElementById("sidebar"),a=document.getElementById("sidebarOverlay"),n=document.getElementById("menuIcon"),s=document.getElementById("closeIcon");let r=!1;function c(){r=!r,r?(e?.classList.remove("-translate-x-full"),e?.classList.add("translate-x-0"),a?.classList.remove("hidden"),n?.classList.add("hidden"),s?.classList.remove("hidden")):(e?.classList.add("-translate-x-full"),e?.classList.remove("translate-x-0"),a?.classList.add("hidden"),n?.classList.remove("hidden"),s?.classList.add("hidden"))}t?.addEventListener("click",c),a?.addEventListener("click",c),e?.querySelectorAll("a").forEach(o=>{o.addEventListener("click",()=>{window.innerWidth<768&&r&&c()})}),window.addEventListener("resize",()=>{window.innerWidth>=768&&r&&(r=!1,e?.classList.add("-translate-x-full"),e?.classList.remove("translate-x-0"),a?.classList.add("hidden"),n?.classList.remove("hidden"),s?.classList.add("hidden"))})}const T="biblia-dark-mode";function R(){const t=localStorage.getItem(T);return t!==null?t==="true":window.matchMedia("(prefers-color-scheme: dark)").matches}function x(t){const e=document.getElementById("sunIcon"),a=document.getElementById("moonIcon");t?(document.documentElement.classList.add("dark"),e?.classList.remove("hidden"),a?.classList.add("hidden")):(document.documentElement.classList.remove("dark"),e?.classList.add("hidden"),a?.classList.remove("hidden"))}function j(){const e=!document.documentElement.classList.contains("dark");localStorage.setItem(T,String(e)),x(e)}function z(){const t=document.getElementById("darkModeToggle");x(R()),t?.addEventListener("click",j)}function J(){const t=document.getElementById("loadingState"),e=document.getElementById("bibleBook");t&&t.classList.add("hidden"),e&&e.classList.remove("hidden")}function W(t){const e=document.getElementById("commentDialog"),a=document.getElementById("commentTitle"),n=document.getElementById("commentContent"),s=document.getElementById("closeCommentDialog"),r=document.getElementById("closeCommentBtn");s?.addEventListener("click",()=>e?.close()),r?.addEventListener("click",()=>e?.close()),e?.addEventListener("click",m=>{m.target===e&&e.close()});function c(){document.querySelectorAll(".note-ref").forEach(m=>{m.addEventListener("click",async u=>{u.preventDefault();const p=u.target.dataset.ref;if(p){a&&(a.textContent="Cargando..."),n&&(n.innerHTML='<div class="text-center py-4"><span class="animate-pulse">Cargando comentario...</span></div>'),e?.showModal();try{const i=await fetch("/api/get-comment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ref:p,bookSlug:t})}),f=await i.json();i.ok&&f.success?(a&&(a.textContent=f.title),n&&(n.innerHTML=`<p>${f.comment}</p>`)):(a&&(a.textContent="Comentario no disponible"),n&&(n.innerHTML=`
							<div class="text-center py-4 text-gray-500">
								<p>No se encontró el comentario para esta referencia.</p>
								<p class="text-xs mt-2 font-mono">${p}</p>
							</div>
						`))}catch(i){console.error("Error al obtener comentario:",i),a&&(a.textContent="Error"),n&&(n.innerHTML='<p class="text-red-500">Error al cargar el comentario.</p>')}}})})}c();const o=new MutationObserver(()=>{setTimeout(c,100)}),l=document.querySelector(".bible-content");l&&o.observe(l,{childList:!0,subtree:!0})}let N=1;function y(t){let e=t.parentElement;for(;e;){const a=e.querySelector(".chapter-marker");if(a)return parseInt(a.dataset.chapter||"1")||1;let n=e.previousElementSibling;for(;n;){const s=n.querySelector?.(".chapter-marker")||(n.classList?.contains("chapter-marker")?n:null);if(s)return parseInt(s.dataset?.chapter||s.getAttribute("data-chapter")||"1")||1;if(n.classList?.contains("chapter-marker"))return parseInt(n.dataset?.chapter||"1")||1;n=n.previousElementSibling}e=e.parentElement}return N}async function k(t){const e=document.getElementById("parallelsDialog"),a=document.getElementById("parallelsTitle"),n=document.getElementById("parallelsContent");document.querySelectorAll(".bible-content sup").forEach(r=>{if(r.classList.contains("verse-clickable")||r.closest(".note-ref"))return;const c=r.textContent?.trim(),o=parseInt(c||"");isNaN(o)||(r.classList.add("verse-clickable"),r.setAttribute("data-verse",o.toString()),r.addEventListener("click",async l=>{if(l.preventDefault(),l.stopPropagation(),!r.classList.contains("has-parallels"))return;const m=parseInt(r.getAttribute("data-verse")||"1"),u=y(r);N=u,a&&(a.textContent="Cargando..."),n&&(n.innerHTML='<div class="text-center py-4"><span class="animate-pulse">Buscando referencias paralelas...</span></div>'),e?.showModal();try{const p=await fetch("/api/get-parallels",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bookSlug:t,chapter:u,verse:m})}),i=await p.json();if(p.ok&&i.success)if(a&&(a.textContent=i.title),i.parallels&&i.parallels.length>0){r.classList.add("has-parallels");const f=i.parallels.map(d=>{const v=d.isNT?'<span class="parallel-badge nt">NT</span>':'<span class="parallel-badge at">AT</span>';let E=`#chapter-${d.firstChapter}`;d.firstVerse&&(E+=`-verse-${d.firstVerse}`);const q=d.bookPath?`<a href="${d.bookPath}${E}" class="parallel-link">${d.reference}</a>`:`<span>${d.reference}</span>`;return`<li>${v}${q}<span class="text-gray-500 dark:text-gray-400 text-xs ml-auto">${d.bookName}</span></li>`}).join("");n&&(n.innerHTML=`
								<p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
									${i.count} referencia${i.count!==1?"s":""} paralela${i.count!==1?"s":""} encontrada${i.count!==1?"s":""}
								</p>
								<ul class="parallels-list">${f}</ul>
							`)}else n&&(n.innerHTML=`
								<div class="text-center py-6 text-gray-500">
									<svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
									</svg>
									<p>No hay referencias paralelas para este versículo.</p>
								</div>
							`);else a&&(a.textContent="Sin paralelos"),n&&(n.innerHTML=`
						<div class="text-center py-4 text-gray-500">
							<p>No se encontraron referencias paralelas.</p>
						</div>
					`)}catch(p){console.error("Error al obtener paralelos:",p),a&&(a.textContent="Error"),n&&(n.innerHTML='<p class="text-red-500">Error al cargar las referencias paralelas.</p>')}}))})}async function Y(t){try{const e=await fetch("/api/get-parallels-list",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bookSlug:t})}),a=await e.json();if(!e.ok||!a.success||!a.verses)return;const n=new Set(a.verses);document.querySelectorAll(".bible-content sup.verse-clickable").forEach(r=>{const c=r.getAttribute("data-verse"),l=`${y(r)}:${c}`;n.has(l)&&(r.classList.add("has-parallels"),r.setAttribute("title","Ver referencias paralelas"))})}catch(e){console.error("Error al precargar paralelos:",e)}}async function F(t){const e=document.getElementById("parallelsDialog"),a=document.getElementById("closeParallelsDialog"),n=document.getElementById("closeParallelsBtn");a?.addEventListener("click",()=>e?.close()),n?.addEventListener("click",()=>e?.close()),e?.addEventListener("click",c=>{c.target===e&&e.close()}),await k(t),await Y(t);const s=new MutationObserver(()=>{setTimeout(()=>k(t),150)}),r=document.querySelector(".bible-content");r&&s.observe(r,{childList:!0,subtree:!0})}let g=!1,h=[],M=1,C=!1;function S(t){M=t}function G(){const t=document.querySelector("main"),e=document.querySelectorAll(".chapter-marker");return h=[],e.forEach(n=>{const s=parseInt(n.getAttribute("data-chapter")||n.textContent||"0");isNaN(s)||h.push({number:s,element:n,offsetTop:n.getBoundingClientRect().top+(t?.scrollTop||0)})}),document.querySelectorAll('[id^="chapter-"]').forEach(n=>{const s=n.id.match(/chapter-(\d+)/);if(s){const r=parseInt(s[1]);h.find(c=>c.number===r)||h.push({number:r,element:n,offsetTop:n.getBoundingClientRect().top+(t?.scrollTop||0)})}}),h.sort((n,s)=>n.number-s.number),h}function K(){const t=document.getElementById("chapterGrid");if(t){if(G(),h.length===0){const e=document.querySelectorAll(".bible-content sup.verse-clickable");let a=1;e.forEach(n=>{const s=y(n);s>a&&(a=s)});for(let n=1;n<=a;n++)h.push({number:n,element:null,offsetTop:0})}t.innerHTML="",h.forEach(e=>{const a=document.createElement("button");a.textContent=e.number.toString(),a.className="bg-stone-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-amber-200 dark:hover:bg-amber-600",e.number===M&&a.classList.add("current-chapter"),a.addEventListener("click",n=>{n.stopPropagation(),_(e.number),b()}),t.appendChild(a)})}}function _(t){const e=document.getElementById(`chapter-${t}`);if(e)e.scrollIntoView({behavior:"smooth",block:"start"});else{const a=document.querySelector(`.chapter-marker[data-chapter="${t}"]`);a&&a.scrollIntoView({behavior:"smooth",block:"start"})}U(t)}function U(t){let e=document.querySelector(".chapter-indicator");e||(e=document.createElement("div"),e.className="chapter-indicator",document.body.appendChild(e)),e.textContent=`Capítulo ${t}`,e.classList.add("visible"),setTimeout(()=>{e.classList.remove("visible")},1500)}function b(){const t=document.getElementById("chapterNavPanel");g=!1,t?.classList.add("hidden")}function Q(){const t=document.getElementById("chapterNavPanel");g=!g,g?(K(),t?.classList.remove("hidden")):t?.classList.add("hidden")}function X(){g=!1,h=[],C||(C=!0,document.addEventListener("click",t=>{const e=t.target,a=document.getElementById("chapterNavPanel"),n=document.getElementById("chapterNavToggle"),s=document.getElementById("closeChapterNav");if(n&&(e===n||n.contains(e))){t.stopPropagation(),Q();return}if(s&&(e===s||s.contains(e))){t.stopPropagation(),b();return}g&&a&&!a.contains(e)&&b()}))}function I(t){const e=document.querySelectorAll(".chapter-marker[data-chapter]");if(e.length===0)return 1;const a=t.getBoundingClientRect(),n=100;let s=1;return e.forEach(r=>{if(r.getBoundingClientRect().top<=a.top+n){const o=parseInt(r.getAttribute("data-chapter")||"1");isNaN(o)||(s=o)}}),s}function w(t){const e=document.getElementById("currentChapterDisplay");e&&(e.textContent=t.toString())}function Z(){const t=document.getElementById("mobileHeader"),e=document.querySelector("#bibliaContainer > main");if(!t||!e){console.warn("Header auto-hide: elementos no encontrados");return}let a=0,n=!0,s=0;const r=10;setTimeout(()=>{const o=I(e);w(o),S(o),s=o},100);function c(){const o=e.scrollTop,l=I(e);if(l!==s&&(w(l),S(l),s=l),window.innerWidth>=768){t.classList.remove("header-hidden"),n=!0;return}const m=document.getElementById("headerSearch");if(m&&!m.classList.contains("hidden")){t.classList.remove("header-hidden"),n=!0;return}const u=o-a;if(Math.abs(u)<r){a=o;return}u>0&&o>60?n&&(t.classList.add("header-hidden"),n=!1):u<0&&(n||(t.classList.remove("header-hidden"),n=!0)),a=o<=0?0:o}e.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",()=>{window.innerWidth>=768&&(t.classList.remove("header-hidden"),n=!0)})}function A(){ee()}function ee(){const t=window.location.hash;if(!t)return;const e=t.match(/^#chapter-(\d+)(?:-verse-(\d+))?$/);if(!e)return;const a=e[1],n=e[2],s=document.getElementById(`chapter-${a}`);s&&(n?setTimeout(()=>{const r=document.querySelectorAll(".bible-content sup");let c=!1,o=0;for(const l of r){const m=l.parentElement?.querySelector(".chapter-marker");m&&(o=parseInt(m.getAttribute("data-chapter")||"0"));let u=l.parentElement;for(;u&&!c;){const f=u.querySelector(".chapter-marker");if(f){o=parseInt(f.getAttribute("data-chapter")||"0");break}let d=u.previousElementSibling;for(;d;){const v=d.querySelector?.(".chapter-marker");if(v){o=parseInt(v.getAttribute("data-chapter")||"0");break}if(d.classList?.contains("chapter-marker")){o=parseInt(d.getAttribute("data-chapter")||"0");break}d=d.previousElementSibling}u=u.parentElement}const p=l.textContent?.trim(),i=parseInt(p||"0");if(o===parseInt(a)&&i===parseInt(n)){l.scrollIntoView({behavior:"smooth",block:"center"}),l.classList.add("verse-highlight"),setTimeout(()=>l.classList.remove("verse-highlight"),2e3),c=!0;break}}c||s.scrollIntoView({behavior:"smooth",block:"start"})},500):setTimeout(()=>{s.scrollIntoView({behavior:"smooth",block:"start"})},300))}function $(){const t=window.currentBibliaSlug;H(t),V(),O(),z(),requestAnimationFrame(()=>{J(),W(t),F(t),A()}),X(),Z()}document.addEventListener("DOMContentLoaded",$);document.addEventListener("astro:page-load",$);window.addEventListener("hashchange",()=>{A()});
